# Fusion Facility Data Semantics Schema
#
# This schema defines PUBLIC data semantics for fusion facilities.
# All classes here are safe for the public graph.
#
# For sensitive infrastructure data (OS, tools, paths, IPs), see:
#   facility_infrastructure.yaml (generates local-only models)
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force

id: https://imas.iter.org/schemas/facility
name: facility
title: Fusion Facility Data Semantics Schema
description: >-
  Public schema for data semantics at fusion research facilities.
  Includes MDSplus trees, diagnostics, analysis codes, and IMAS mappings.
  Infrastructure data is in a separate schema and never graphed.

license: MIT
version: 0.2.0

prefixes:
  linkml: https://w3id.org/linkml/
  facility: https://imas.iter.org/schemas/facility/
  imas: https://imas.iter.org/

default_prefix: facility
default_range: string

imports:
  - linkml:types

# =============================================================================
# Enums
# =============================================================================

enums:
  TreeNodeType:
    description: MDSplus node data types
    permissible_values:
      STRUCTURE:
        description: Container node with no data
      SIGNAL:
        description: Time-varying measurement data
      NUMERIC:
        description: Numeric scalar or array
      TEXT:
        description: Text/string data
      AXIS:
        description: Coordinate axis data
      SUBTREE:
        description: Reference to another tree
      ACTION:
        description: Action sequence node
      DISPATCH:
        description: Dispatch scheduling node
      TASK:
        description: Task definition node

  DiagnosticCategory:
    description: Categories of fusion plasma diagnostics
    permissible_values:
      magnetics:
        description: Magnetic field and flux measurements
      spectroscopy:
        description: Spectroscopic diagnostics (visible, UV, X-ray)
      particle:
        description: Particle diagnostics (CX, NPA, beam emission)
      imaging:
        description: Camera and imaging systems
      microwave:
        description: Microwave diagnostics (ECE, reflectometry)
      bolometry:
        description: Radiated power measurements
      neutron:
        description: Neutron flux and spectrum diagnostics
      probe:
        description: Langmuir probes and other insertable probes
      interferometry:
        description: Interferometric density measurements
      thomson:
        description: Thomson scattering systems

  AnalysisCodeType:
    description: Types of physics analysis codes
    permissible_values:
      equilibrium:
        description: Equilibrium reconstruction (EFIT, LIUQE, CLISTE)
      transport:
        description: Transport analysis (ASTRA, TRANSP, JETTO)
      mhd:
        description: MHD stability analysis
      heating:
        description: Heating deposition codes (TORAY, TORBEAM, NUBEAM)
      control:
        description: Real-time plasma control systems
      profile_fitting:
        description: Profile fitting and kinetic analysis
      integrated:
        description: Integrated modeling workflows

  ServerRole:
    description: Role of a data server in the facility infrastructure
    permissible_values:
      primary:
        description: Main production data server
      secondary:
        description: Backup or read-replica server
      legacy:
        description: Historical/archived data server
      realtime:
        description: Real-time control system data
      analysis:
        description: Analysis results server

  DataFormatType:
    description: Types of data storage formats
    permissible_values:
      mdsplus:
        description: MDSplus tree-based storage
      hdf5:
        description: HDF5 hierarchical data format
      netcdf:
        description: NetCDF scientific data format
      csv:
        description: Comma-separated values
      json:
        description: JSON data files
      mat:
        description: MATLAB .mat files
      idl:
        description: IDL save files
      imas:
        description: IMAS data format

  ProgrammingLanguage:
    description: Programming languages for code examples
    permissible_values:
      python:
        description: Python source code
      matlab:
        description: MATLAB/Octave code
      fortran:
        description: Fortran source code
      idl:
        description: IDL (Interactive Data Language)
      tdi:
        description: TDI (Tree Data Interface) expressions
      cpp:
        description: C++ source code
      julia:
        description: Julia source code

  PathType:
    description: Types of filesystem paths at a facility
    permissible_values:
      code_directory:
        description: Directory containing analysis codes or scripts
      data_directory:
        description: Directory containing data files
      config_directory:
        description: Directory containing configuration files
      binary_directory:
        description: Directory containing executables

  PathStatus:
    description: Exploration status of a facility path
    permissible_values:
      pending:
        description: Discovered but not yet explored
      exploring:
        description: Currently being explored by an agent
      explored:
        description: Directory contents have been listed and child paths created
      ingested:
        description: Code content has been ingested into the graph
      excluded:
        description: Marked to skip (e.g., user homes, tmp)
      stale:
        description: Path may no longer exist, needs re-verification

# =============================================================================
# Core Classes
# =============================================================================

classes:
  Facility:
    description: >-
      A fusion research facility. Root node for facility-specific knowledge.
    class_uri: facility:Facility
    attributes:
      id:
        identifier: true
        description: Unique facility identifier (e.g., "epfl", "iter", "jet")
        required: true
      name:
        description: Human-readable facility name (e.g., "EPFL/TCV")
        required: true
      description:
        description: Facility description
      machine:
        description: Tokamak/stellarator name (e.g., "TCV", "ITER", "JET")
      location:
        description: Geographic location

  FacilityPath:
    description: >-
      A filesystem path at a remote facility for structured exploration.
      
      EXPLORATION WORKFLOW:
      1. Paths start with status=pending when discovered
      2. Agent explores pending paths via SSH, creates child paths
      3. After listing contents: status=explored
      4. After code ingestion: status=ingested
      5. Use status=excluded to skip (e.g., /tmp, user homes)
      
      Query pending paths via get_facility() before SSH exploration.
    class_uri: facility:FacilityPath
    attributes:
      id:
        identifier: true
        description: Composite key as facility:path (e.g., "epfl:/home/codes")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      path:
        description: Absolute filesystem path
        required: true
      path_type:
        description: Type of path
        range: PathType
        required: true
      status:
        description: Exploration status
        range: PathStatus
        required: true
      parent_path_id:
        description: Parent directory path ID (null for root paths)
        range: FacilityPath
      depth:
        description: Distance from root path (0 = root like /home/codes)
        range: integer
      description:
        description: Human-readable description of what this path contains
      discovered_at:
        description: When this path was first discovered
        range: datetime
      explored_at:
        description: When this path was last explored
        range: datetime

# =============================================================================
# Data Infrastructure Classes (Public - no IPs or paths)
# =============================================================================

  MDSplusServer:
    description: An MDSplus data server (internal name only, no IP)
    class_uri: facility:MDSplusServer
    attributes:
      hostname:
        identifier: true
        description: Server name (e.g., "tcvdata", not IP address)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      role:
        description: Server role in the infrastructure
        range: ServerRole
      description:
        description: What data this server hosts

  MDSplusTree:
    description: An MDSplus tree (hierarchical data container)
    class_uri: facility:MDSplusTree
    attributes:
      name:
        identifier: true
        description: Tree name (e.g., "tcv_shot", "results")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      server_hostname:
        description: Primary server hosting this tree
        range: MDSplusServer
      description:
        description: Tree description
      shot_dependent:
        description: Whether tree structure varies by shot
        range: boolean
        ifabsent: "true"

  TreeNode:
    description: A node within an MDSplus tree
    class_uri: facility:TreeNode
    attributes:
      path:
        identifier: true
        description: Full node path (e.g., "\\RESULTS::LIUQE:IP")
        required: true
      tree_name:
        description: Parent tree name
        required: true
        range: MDSplusTree
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      node_type:
        description: MDSplus node data type
        range: TreeNodeType
      units:
        description: Physical units (SI)
      description:
        description: Node description
      example_shot:
        description: Example shot number where this node exists
        range: integer

  TDIFunction:
    description: A TDI function providing high-level data access
    class_uri: facility:TDIFunction
    attributes:
      name:
        identifier: true
        description: Function name (e.g., "tcv_eq", "tcv_ip")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      description:
        description: Function description
      parameters:
        description: Function parameter names
        multivalued: true
      return_type:
        description: Return type description

  ShotRange:
    description: A range of shot numbers with common characteristics
    class_uri: facility:ShotRange
    attributes:
      id:
        identifier: true
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      name:
        description: Name or description of this range
      start_shot:
        description: First shot number
        range: integer
      end_shot:
        description: Last shot number (null if ongoing)
        range: integer
      description:
        description: What this shot range represents

# =============================================================================
# Data Semantics Classes
# =============================================================================

  Diagnostic:
    description: A plasma diagnostic system
    class_uri: facility:Diagnostic
    attributes:
      name:
        identifier: true
        description: Diagnostic name (e.g., "Thomson", "ECE", "MSE")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      category:
        description: Diagnostic category
        range: DiagnosticCategory
      description:
        description: Diagnostic description

  AnalysisCode:
    description: A physics analysis or simulation code
    class_uri: facility:AnalysisCode
    attributes:
      name:
        identifier: true
        description: Code name (e.g., "LIUQE", "ASTRA", "TORAY")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      code_type:
        description: Type of analysis
        range: AnalysisCodeType
      description:
        description: Code description
      version:
        description: Code version if known
      installed_at:
        description: Installation path (links to FacilityPath)
        range: FacilityPath

# =============================================================================
# IMAS Mapping Classes
# =============================================================================

  IMASPath:
    description: An IMAS data dictionary path
    class_uri: imas:Path
    attributes:
      path:
        identifier: true
        description: Full IMAS path
        required: true
      ids:
        description: IDS name (e.g., "equilibrium", "core_profiles")
        required: true
      description:
        description: Path description from IMAS DD
      units:
        description: Physical units from IMAS DD

  IMASMapping:
    description: A mapping from facility-specific data to IMAS
    class_uri: facility:IMASMapping
    attributes:
      id:
        identifier: true
        required: true
      source_path:
        description: Source path (TreeNode or TDI function)
        required: true
        range: TreeNode
      target_path:
        description: Target IMAS path
        required: true
        range: IMASPath
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      transformation:
        description: Transformation expression (e.g., unit conversion)
      validated:
        description: Whether this mapping has been validated
        range: boolean
      notes:
        description: Mapping notes

# =============================================================================
# Code Examples Classes
# =============================================================================

  CodeExample:
    description: >-
      A code file containing examples of reading/writing fusion data.
      Links to facility and tracks source location for provenance.
    class_uri: facility:CodeExample
    attributes:
      id:
        identifier: true
        description: Unique identifier (facility:filename hash)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      source_file:
        description: Remote file path (e.g., /home/wilson/data/load_to_imas.py)
        required: true
      language:
        description: Programming language
        range: ProgrammingLanguage
        required: true
      title:
        description: Human-readable title or filename
      description:
        description: Description of what this code does
      author:
        description: Username or author name if known
      related_ids:
        description: IDS names this code interacts with (coarse linking)
        multivalued: true
      ingested_at:
        description: Timestamp when this was ingested
        range: datetime

  CodeChunk:
    description: >-
      A searchable chunk of code from a CodeExample.
      Contains embedding for semantic search and links to IMAS paths.
    class_uri: facility:CodeChunk
    attributes:
      id:
        identifier: true
        description: Unique chunk identifier
        required: true
      code_example_id:
        description: Parent CodeExample
        required: true
        range: CodeExample
      content:
        description: The actual code content
        required: true
      function_name:
        description: Function or class name if applicable
      start_line:
        description: Starting line number in source file
        range: integer
      end_line:
        description: Ending line number in source file
        range: integer
      embedding:
        description: Vector embedding for semantic search (stored as list of floats)
        multivalued: true
        range: float
      related_paths:
        description: Specific IMAS paths this chunk references
        multivalued: true
        range: IMASPath
